using System.ComponentModel;
using System.Text.Json;
using CalendarMcp.Core.Models;
using CalendarMcp.Core.Services;
using Microsoft.Extensions.Logging;
using ModelContextProtocol.Server;

namespace CalendarMcp.Core.Tools;

[McpServerToolType]
public sealed class GetCalendarEventsTool(
    IAccountRegistry accountRegistry,
    IProviderServiceFactory providerFactory,
    ILogger<GetCalendarEventsTool> logger)
{
    [McpServerTool, Description("Get events (past/present/future) for specific account or all accounts")]
    public async Task<string> GetCalendarEvents(
        [Description("Start date for event range (ISO 8601 format)")] DateTime startDate,
        [Description("End date for event range (ISO 8601 format)")] DateTime endDate,
        [Description("Specific account ID, or omit for all accounts")] string? accountId = null,
        [Description("Specific calendar ID, or omit for all calendars")] string? calendarId = null,
        [Description("Maximum number of events to retrieve")] int count = 50)
    {
        logger.LogInformation("Getting calendar events: {Start} to {End}, accountId={AccountId}",
            startDate, endDate, accountId);

        try
        {
            var accounts = string.IsNullOrEmpty(accountId)
                ? await accountRegistry.GetAllAccountsAsync()
                : new[] { await accountRegistry.GetAccountAsync(accountId) };

            var validAccounts = accounts.Where(a => a != null).ToList();

            if (validAccounts.Count == 0)
            {
                return JsonSerializer.Serialize(new { error = accountId != null ? $"Account '{accountId}' not found" : "No accounts found" });
            }

            var tasks = validAccounts.Select(async account =>
            {
                try
                {
                    var provider = providerFactory.GetProvider(account!.Provider);
                    return await provider.GetCalendarEventsAsync(account.AccountId, calendarId, startDate, endDate, count, CancellationToken.None);
                }
                catch (Exception ex)
                {
                    logger.LogError(ex, "Error getting events from account {AccountId}", account!.AccountId);
                    return Enumerable.Empty<CalendarEvent>();
                }
            });

            var results = await Task.WhenAll(tasks);
            var allEvents = results.SelectMany(e => e).OrderBy(e => e.Start).ToList();

            var response = new
            {
                events = allEvents.Select(e => new { id = e.Id, accountId = e.AccountId, calendarId = e.CalendarId, subject = e.Subject, start = e.Start, end = e.End, location = e.Location, attendees = e.Attendees, isAllDay = e.IsAllDay, organizer = e.Organizer })
            };

            logger.LogInformation("Retrieved {Count} events", allEvents.Count);
            return JsonSerializer.Serialize(response, new JsonSerializerOptions { WriteIndented = true });
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error in get_calendar_events tool");
            return JsonSerializer.Serialize(new { error = "Failed to get events", message = ex.Message });
        }
    }
}
